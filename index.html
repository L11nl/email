<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø°ÙƒÙŠ | Smart Inventory</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body{
      font-family:'Tajawal', sans-serif;
      background:
        radial-gradient(900px 500px at 15% -10%, rgba(59,130,246,.18), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(16,185,129,.12), transparent 55%),
        #0b1224;
      color:#e2e8f0;
      overflow-x:hidden;
    }

    /* Scrollbar */
    ::-webkit-scrollbar{ width:8px; }
    ::-webkit-scrollbar-track{ background:#070c18; }
    ::-webkit-scrollbar-thumb{ background:#3b82f6; border-radius:6px; }
    ::-webkit-scrollbar-thumb:hover{ background:#2563eb; }

    /* Glass (Ø®ÙÙŠÙ ÙˆØ³Ù„Ø³) */
    .glass-panel{
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø© + Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ø¨Ø³ÙŠØ·Ø© */
    .soft{
      transition: background .16s ease, border-color .16s ease, box-shadow .16s ease, transform .06s ease;
      will-change: auto;
    }

    /* Ù„Ù…Ø¹Ø© Ø¨Ø³ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
    .press-glow:active{
      box-shadow: 0 0 0 3px rgba(255,255,255,.08), 0 0 18px rgba(59,130,246,.20);
      transform: translateY(1px);
    }

    /* Ù„Ù…Ø¹Ø© Ù‚ØµÙŠØ±Ø© (JS ÙŠØ¶ÙŠÙ class) */
    .flash{
      animation: flash .22s ease-out;
    }
    @keyframes flash{
      0%{ box-shadow: 0 0 0 rgba(255,255,255,0); }
      100%{ box-shadow: 0 0 0 3px rgba(255,255,255,.08), 0 0 22px rgba(56,189,248,.20); }
    }

    /* Ù†Øµ ÙŠÙ„Ù…Ø¹ (Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„ØªÙˆØ¶ÙŠØ­ÙŠ) */
    .glow-text{
      color:#cbd5e1;
      text-shadow:
        0 0 10px rgba(56,189,248,.18),
        0 0 22px rgba(16,185,129,.10);
    }

    /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Ø³Ø® */
    .field-copy{
      cursor:pointer;
      transition: background .16s ease, border-color .16s ease, box-shadow .16s ease;
    }
    .field-copy:hover{
      background-color: rgba(51,65,85,.25);
      border-color: rgba(59,130,246,.35);
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }

    /* Ø´Ø§Ø±Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨ */
    .tab-pill{
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.45);
    }
    .tab-active{
      border-color: rgba(59,130,246,.45);
      background: rgba(59,130,246,.10);
      box-shadow: 0 0 0 3px rgba(59,130,246,.12);
    }

    /* Canvas snow overlay */
    #snowCanvas{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 5;
      opacity: .55; /* Ø®ÙÙŠÙ */
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center py-10 px-4">

  <!-- Ø«Ù„Ø¬ Ø®ÙÙŠÙ Ø´ÙØ§Ù -->
  <canvas id="snowCanvas"></canvas>

  <header class="w-full max-w-5xl mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-5 relative z-10">
    <div class="space-y-1">
      <h1 class="text-3xl font-extrabold text-blue-400 flex items-center gap-3">
        <i class="fa-solid fa-boxes-stacked"></i>
        <span id="titleName">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø°ÙƒÙŠ</span>
      </h1>
      <p class="text-slate-400 text-sm">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</p>
      <p class="glow-text text-xs">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù†Ø³Ø® ÙŠØ¹Ù…Ù„ Ø£ÙØ¶Ù„ Ø¹Ù„Ù‰ HTTPS Ø£Ùˆ localhost â€” ÙˆØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø© Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ âœ¨
      </p>
    </div>

    <div class="flex gap-3 w-full md:w-auto items-center">
      <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª: Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ / Gemini -->
      <div class="flex gap-2">
        <button id="tabMain" class="press-glow soft tab-pill tab-active px-4 py-2 rounded-2xl text-sm font-bold text-slate-100">
          <i class="fa-solid fa-layer-group ml-2 text-blue-300"></i> Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        </button>
        <button id="tabGemini" class="press-glow soft tab-pill px-4 py-2 rounded-2xl text-sm font-bold text-slate-100">
          <i class="fa-solid fa-wand-magic-sparkles ml-2 text-purple-300"></i> Gemini
        </button>
      </div>

      <div class="glass-panel soft px-5 py-3 rounded-2xl text-center shadow-lg shadow-blue-500/10">
        <span class="block text-xs text-slate-400">Ø§Ù„Ù…ØªÙˆÙØ± Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
        <span id="stockCount" class="text-2xl font-extrabold text-emerald-300">0</span>
      </div>
      <div class="glass-panel soft px-5 py-3 rounded-2xl text-center shadow-lg shadow-purple-500/10">
        <span class="block text-xs text-slate-400">ØªÙ… Ø³Ø­Ø¨Ù‡Ø§</span>
        <span id="pulledCount" class="text-2xl font-extrabold text-purple-300">0</span>
      </div>
    </div>
  </header>

  <main class="w-full max-w-5xl space-y-6 relative z-10">

    <!-- Ø£Ø¯ÙˆØ§Øª Ø°ÙƒÙŠØ© Ø³Ø±ÙŠØ¹Ø© -->
    <section class="glass-panel soft p-5 rounded-3xl shadow-xl">
      <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-sparkles text-amber-300"></i>
          <span class="font-extrabold text-white">Ø£Ø¯ÙˆØ§Øª Ø°ÙƒÙŠØ©</span>
          <span class="text-xs glow-text">ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø´ØºÙ„ + Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± + Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</span>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
          <div class="relative flex-1 md:w-72">
            <input id="searchInput" type="text"
              class="w-full bg-slate-950/30 text-sm text-white px-4 py-3 rounded-2xl border border-slate-700/60 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition placeholder-slate-500"
              placeholder="Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)..." />
            <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
          </div>

          <button id="smartStatsBtn"
            class="press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold px-5 py-3 rounded-2xl flex items-center justify-center gap-2">
            <i class="fa-solid fa-chart-simple text-emerald-300"></i>
            <span>Ù…Ù„Ø®Øµ Ø°ÙƒÙŠ</span>
          </button>

          <button id="undoPullBtn"
            class="press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold px-5 py-3 rounded-2xl flex items-center justify-center gap-2">
            <i class="fa-solid fa-rotate-left text-amber-300"></i>
            <span>ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø³Ø­Ø¨</span>
          </button>
        </div>
      </div>

      <div id="smartPanel" class="hidden mt-4 bg-slate-950/25 border border-slate-700/40 rounded-2xl p-4">
        <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
          <div class="text-sm text-slate-200">
            <div class="font-bold mb-1">ğŸ“Œ Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div class="text-xs glow-text" id="smartSummary">---</div>
          </div>
          <div class="flex gap-2">
            <button id="copyCompactBtn"
              class="press-glow soft bg-indigo-600/70 hover:bg-indigo-600 text-white font-bold px-4 py-2 rounded-2xl flex items-center gap-2">
              <i class="fa-solid fa-clipboard text-indigo-100"></i>
              <span>Ù†Ø³Ø® Ø¢Ø®Ø± Ø­Ø³Ø§Ø¨ (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯)</span>
            </button>
            <button id="clearSearchBtn"
              class="press-glow soft bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold px-4 py-2 rounded-2xl flex items-center gap-2">
              <i class="fa-solid fa-eraser text-slate-200"></i>
              <span>Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <section class="glass-panel soft p-6 rounded-3xl shadow-xl">
      <div class="flex justify-between items-center mb-4 gap-3">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <i class="fa-solid fa-cloud-arrow-up text-blue-400"></i>
          <span>ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
        </h2>

        <button id="toggleBtn" class="press-glow soft text-slate-300 hover:text-white text-sm underline">
          Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø±
        </button>
      </div>

      <div id="inputSection" class="space-y-4">
        <!-- Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚Ø¯ÙŠÙ… -->
        <textarea id="bulkInput" rows="5"
          class="w-full bg-slate-950/30 text-sm text-white p-4 rounded-2xl border border-slate-700/60 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 outline-none transition placeholder-slate-500"
          placeholder="Ø¶Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‡Ù†Ø§ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚:
email;pass;recovery;url
email;pass;recovery;url"></textarea>

        <!-- Ø®Ø§Ù†Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ø³Ø±ÙŠØ¹Ø© -->
        <div class="bg-slate-950/15 border border-slate-700/40 rounded-2xl p-3">
          <div class="flex items-center gap-2 mb-2 text-slate-200">
            <i class="fa-solid fa-bolt text-amber-300"></i>
            <span class="font-bold">Ø®Ø§Ù†Ø© Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” ØªÙ†Ø³ÙŠÙ‚ Ø³Ø±ÙŠØ¹</span>
          </div>
          <p class="text-xs glow-text mb-2">
            ÙƒÙ„ Ø³Ø·Ø±: <span class="font-mono text-slate-200">email@gmail.comPASSWORD</span> (Ø¨Ø¯ÙˆÙ† ÙÙˆØ§ØµÙ„)
          </p>
          <textarea id="quickInput" rows="3"
            class="w-full bg-slate-950/30 text-sm text-white p-4 rounded-2xl border border-slate-700/60 focus:border-amber-400 focus:ring-2 focus:ring-amber-400/20 outline-none transition placeholder-slate-500"
            placeholder="Ù…Ø«Ø§Ù„:
oyufezusu066@gmail.comIsbzXRgTi77up"></textarea>
        </div>

        <div class="flex flex-col md:flex-row justify-between gap-3">
          <button id="clearBtn"
            class="press-glow soft text-red-200 hover:text-red-100 transition px-4 py-2 rounded-xl border border-red-900/40 bg-red-950/20 hover:bg-red-950/30">
            <i class="fa-solid fa-trash ml-1"></i> ØªØµÙÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
          </button>

          <div class="flex flex-col sm:flex-row gap-3">
            <button id="importBtn"
              class="press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold py-3 px-6 rounded-2xl flex items-center justify-center gap-2">
              <i class="fa-solid fa-file-arrow-up text-blue-300"></i>
              <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù</span>
            </button>
            <input id="importFile" type="file" accept=".txt" class="hidden" />

            <button id="exportBtn"
              class="press-glow soft bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold py-3 px-6 rounded-2xl flex items-center justify-center gap-2">
              <i class="fa-solid fa-file-arrow-down text-emerald-300"></i>
              <span>ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
            </button>

            <button id="addBtn"
              class="press-glow soft bg-blue-600 hover:bg-blue-500 text-white font-extrabold py-3 px-7 rounded-2xl shadow-lg shadow-blue-600/15 flex items-center justify-center gap-2">
              <i class="fa-solid fa-plus"></i>
              <span>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <div class="flex justify-center py-2">
      <button id="pullBtn"
        class="press-glow soft relative group bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 text-white text-2xl font-black py-5 px-8 md:px-12 rounded-3xl shadow-2xl shadow-emerald-500/20 w-full md:w-auto">
        <div class="flex items-center justify-center gap-3">
          <i class="fa-solid fa-hand-holding-hand"></i>
          <span>Ø³Ø­Ø¨ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</span>
        </div>
      </button>
    </div>

    <section id="resultArea" class="hidden">
      <div class="glass-panel soft p-1 rounded-[26px] border border-slate-600/50 shadow-2xl">
        <div class="bg-slate-950/25 rounded-[22px] p-6">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 pb-4 border-b border-slate-700/60 gap-2">
            <span class="text-emerald-300 font-extrabold text-lg flex items-center gap-2">
              <i class="fa-solid fa-check-circle"></i>
              ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­
            </span>
            <span class="text-xs text-slate-400 font-mono" id="timestamp"></span>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="press-glow field-copy soft bg-slate-950/25 p-3 rounded-2xl border border-slate-700/60 group"
                 data-copy="email">
              <label class="text-xs text-slate-400 block mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Email)</label>
              <div class="flex justify-between items-center gap-3">
                <span id="emailDisplay" class="font-mono text-blue-300 truncate">---</span>
                <i class="fa-regular fa-copy text-slate-500 group-hover:text-white"></i>
              </div>
            </div>

            <div class="press-glow field-copy soft bg-slate-950/25 p-3 rounded-2xl border border-slate-700/60 group"
                 data-copy="password">
              <label class="text-xs text-slate-400 block mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Password)</label>
              <div class="flex justify-between items-center gap-3">
                <span id="passDisplay" class="font-mono text-rose-300 truncate">---</span>
                <i class="fa-regular fa-copy text-slate-500 group-hover:text-white"></i>
              </div>
            </div>

            <div class="press-glow field-copy soft bg-slate-950/25 p-3 rounded-2xl border border-slate-700/60 group"
                 data-copy="recovery">
              <label class="text-xs text-slate-400 block mb-1">Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ (Recovery Email)</label>
              <div class="flex justify-between items-center gap-3">
                <span id="recDisplay" class="font-mono text-amber-300 truncate">---</span>
                <i class="fa-regular fa-copy text-slate-500 group-hover:text-white"></i>
              </div>
            </div>

            <div class="soft bg-slate-950/25 p-3 rounded-2xl border border-slate-700/60 flex justify-between items-center gap-3">
              <div>
                <label class="text-xs text-slate-400 block mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Webhook)</label>
                <span class="text-xs glow-text">Ù„Ù„ÙˆØµÙˆÙ„ Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</span>
              </div>
              <a id="urlBtn" href="#" target="_blank" rel="noopener"
                 class="press-glow soft bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-4 py-2 rounded-xl transition shadow-lg shadow-indigo-600/15">
                <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i> ÙØªØ­
              </a>
            </div>
          </div>

          <div class="mt-2 space-y-2">
            <button id="copyFullBtn"
              class="press-glow soft w-full bg-slate-800/55 hover:bg-slate-700/60 border border-slate-700/60 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 group">
              <i class="fa-solid fa-clipboard-list text-blue-300"></i>
              <span>Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§Ù…Ù„Ø© (Ø´Ø§Ù…Ù„)</span>
            </button>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 pt-2">
              <button id="restoreBtn"
                class="press-glow soft bg-emerald-700/30 hover:bg-emerald-700/40 border border-emerald-700/35 text-emerald-100 font-bold py-3 rounded-2xl flex items-center justify-center gap-2">
                <i class="fa-solid fa-rotate-left text-emerald-300"></i>
                <span>Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</span>
              </button>

              <button id="deleteLastBtn"
                class="press-glow soft bg-red-700/20 hover:bg-red-700/28 border border-red-700/30 text-red-100 font-bold py-3 rounded-2xl flex items-center justify-center gap-2">
                <i class="fa-solid fa-xmark text-red-300"></i>
                <span>Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©</span>
              </button>

              <!-- Ø²Ø± Ù†Ù‚Ù„ Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ -->
              <button id="moveToGeminiBtn"
                class="press-glow soft bg-purple-700/25 hover:bg-purple-700/35 border border-purple-700/35 text-purple-100 font-bold py-3 rounded-2xl flex items-center justify-center gap-2">
                <i class="fa-solid fa-right-left text-purple-300"></i>
                <span>Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Gemini</span>
              </button>
            </div>

            <p class="text-center text-[11px] glow-text">
              âœ… Ø¢Ø®Ø± Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ ÙŠØ¨Ù‚Ù‰ Ù…Ø­ÙÙˆØ¸ Ø­ØªÙ‰ Ù„Ùˆ Ø®Ø±Ø¬Øª ÙˆØ±Ø¬Ø¹Øª Ù„Ø§Ø­Ù‚Ø§Ù‹.
            </p>
          </div>

        </div>
      </div>
    </section>

  </main>

  <!-- Toast -->
  <div id="toast"
    class="fixed bottom-5 left-5 bg-slate-900/90 border border-slate-700/70 text-white px-5 py-3 rounded-2xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
    <i id="toastIcon" class="fa-solid fa-info-circle"></i>
    <span id="toastMsg">ØªÙ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</span>
  </div>

  <script>
    (function () {
      // DOM
      const stockCountEl = document.getElementById('stockCount');
      const pulledCountEl = document.getElementById('pulledCount');

      const titleNameEl = document.getElementById('titleName');

      const tabMain = document.getElementById('tabMain');
      const tabGemini = document.getElementById('tabGemini');

      const inputSectionEl = document.getElementById('inputSection');
      const bulkInputEl = document.getElementById('bulkInput');
      const quickInputEl = document.getElementById('quickInput');

      const searchInputEl = document.getElementById('searchInput');
      const smartStatsBtn = document.getElementById('smartStatsBtn');
      const smartPanel = document.getElementById('smartPanel');
      const smartSummary = document.getElementById('smartSummary');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      const copyCompactBtn = document.getElementById('copyCompactBtn');
      const undoPullBtn = document.getElementById('undoPullBtn');

      const resultAreaEl = document.getElementById('resultArea');
      const timestampEl = document.getElementById('timestamp');

      const emailDisplayEl = document.getElementById('emailDisplay');
      const passDisplayEl = document.getElementById('passDisplay');
      const recDisplayEl = document.getElementById('recDisplay');
      const urlBtnEl = document.getElementById('urlBtn');

      const toggleBtn = document.getElementById('toggleBtn');
      const clearBtn = document.getElementById('clearBtn');
      const addBtn = document.getElementById('addBtn');
      const pullBtn = document.getElementById('pullBtn');
      const copyFullBtn = document.getElementById('copyFullBtn');

      const restoreBtn = document.getElementById('restoreBtn');
      const deleteLastBtn = document.getElementById('deleteLastBtn');
      const moveToGeminiBtn = document.getElementById('moveToGeminiBtn');

      const importBtn = document.getElementById('importBtn');
      const importFile = document.getElementById('importFile');
      const exportBtn = document.getElementById('exportBtn');

      const toast = document.getElementById('toast');
      const toastMsg = document.getElementById('toastMsg');
      const toastIcon = document.getElementById('toastIcon');
      let toastTimeout;

      // Tabs / State
      const TABS = { MAIN: 'main', GEMINI: 'gemini' };
      let activeTab = TABS.MAIN;

      // Storage Keys (Ù…Ø®Ø²ÙˆÙ†ÙŠÙ† Ù…Ù†ÙØµÙ„ÙŠÙ†)
      const STORAGE_KEYS = {
        main:   { data:'smartInventory_data',   pulled:'smartInventory_pulled',   last:'smartInventory_lastPulled',   undo:'smartInventory_undo' },
        gemini: { data:'smartGemini_data',      pulled:'smartGemini_pulled',      last:'smartGemini_lastPulled',      undo:'smartGemini_undo' }
      };

      // Data for both tabs
      let store = {
        main:   { inventory: [], pulledCounter: 0, currentAccount: null },
        gemini: { inventory: [], pulledCounter: 0, currentAccount: null }
      };

      // Utils
      function safeJsonParse(value, fallback) { try { return JSON.parse(value); } catch { return fallback; } }

      function flash(el){
        if(!el) return;
        el.classList.remove('flash');
        void el.offsetWidth;
        el.classList.add('flash');
        setTimeout(()=> el.classList.remove('flash'), 260);
      }

      function showToast(message, type = 'info') {
        toastMsg.textContent = message;

        toast.className =
          "fixed bottom-5 left-5 px-5 py-3 rounded-2xl shadow-2xl transform transition-all duration-300 z-50 flex items-center gap-3 font-bold border";

        if (type === 'success') {
          toast.classList.add('bg-emerald-950/80', 'border-emerald-800/60', 'text-emerald-100');
          toastIcon.className = "fa-solid fa-circle-check text-emerald-300";
        } else if (type === 'error') {
          toast.classList.add('bg-red-950/80', 'border-red-800/60', 'text-red-100');
          toastIcon.className = "fa-solid fa-triangle-exclamation text-red-300";
        } else if (type === 'copy') {
          toast.classList.add('bg-blue-950/80', 'border-blue-800/60', 'text-blue-100');
          toastIcon.className = "fa-solid fa-copy text-blue-300";
        } else {
          toast.classList.add('bg-slate-900/90', 'border-slate-700/70', 'text-white');
          toastIcon.className = "fa-solid fa-info-circle text-slate-200";
        }

        toast.classList.remove('translate-y-20', 'opacity-0');
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 2300);
      }

      async function copyText(text) {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (_) {}

        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.top = '-9999px';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand('copy');
          document.body.removeChild(ta);
          return ok;
        } catch (_) {
          return false;
        }
      }

      // Active data getters
      function K(){ return STORAGE_KEYS[activeTab]; }
      function S(){ return store[activeTab]; }

      function saveActive() {
        const keys = K();
        const s = S();
        localStorage.setItem(keys.data, JSON.stringify(s.inventory));
        localStorage.setItem(keys.pulled, String(s.pulledCounter));
        if (s.currentAccount) localStorage.setItem(keys.last, JSON.stringify(s.currentAccount));
      }

      function loadActive() {
        const keys = K();
        const data = localStorage.getItem(keys.data);
        const pulled = localStorage.getItem(keys.pulled);
        const s = S();
        s.inventory = data ? safeJsonParse(data, []) : [];
        s.pulledCounter = pulled ? Number(pulled) || 0 : 0;
      }

      function getLastPulled(tab) {
        const keys = STORAGE_KEYS[tab];
        const last = localStorage.getItem(keys.last);
        return last ? safeJsonParse(last, null) : null;
      }

      function clearLastPulled(tab) {
        const keys = STORAGE_KEYS[tab];
        localStorage.removeItem(keys.last);
      }

      function setUndo(tab, obj){
        const keys = STORAGE_KEYS[tab];
        localStorage.setItem(keys.undo, JSON.stringify(obj || null));
      }
      function getUndo(tab){
        const keys = STORAGE_KEYS[tab];
        const v = localStorage.getItem(keys.undo);
        return v ? safeJsonParse(v, null) : null;
      }

      function setStockCounterColor(stockLen) {
        if (stockLen === 0) stockCountEl.className = "text-2xl font-extrabold text-red-400";
        else if (stockLen < 5) stockCountEl.className = "text-2xl font-extrabold text-amber-300";
        else stockCountEl.className = "text-2xl font-extrabold text-emerald-300";
      }

      function updateUI() {
        const s = S();
        const filtered = applySearch(s.inventory);
        stockCountEl.textContent = filtered.length;
        pulledCountEl.textContent = s.pulledCounter;
        setStockCounterColor(filtered.length);

        // Ø¥Ø°Ø§ ÙÙŠ Ø­Ø³Ø§Ø¨ Ù…Ø­ÙÙˆØ¸ Ø¢Ø®Ø± Ù…Ø±Ø©
        const last = s.currentAccount || getLastPulled(activeTab);
        if (last) {
          s.currentAccount = last;
          displayResult(last);
        } else {
          resultAreaEl.classList.add('hidden');
        }

        updateSmartSummary();
      }

      function displayResult(acc) {
        if (!acc) return;
        resultAreaEl.classList.remove('hidden');
        emailDisplayEl.textContent = acc.email || '---';
        passDisplayEl.textContent = acc.password || '---';
        recDisplayEl.textContent = acc.recovery || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
        urlBtnEl.href = acc.url && acc.url !== '' ? acc.url : '#';

        const now = new Date();
        timestampEl.textContent = now.toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      }

      // Parsing
      function parseStandardLine(line) {
        const parts = line.split(';').map(p => p.trim());
        if (parts.length < 2) return { ok: false };
        const email = parts[0];
        const password = parts[1];
        const recovery = parts[2] || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
        const url = parts[3] || "#";
        if (!email || !password) return { ok: false };
        return { ok: true, acc: { email, password, recovery, url } };
      }

      function parseQuickLine(line) {
        const m = line.match(/^([^\s@]+@[^\s@]+\.[^\s@]+)(.+)$/);
        if (!m) return { ok: false };
        const email = (m[1] || '').trim();
        const password = (m[2] || '').trim();
        if (!email || !password) return { ok: false };
        return { ok: true, acc: { email, password, recovery: "ØºÙŠØ± Ù…ØªÙˆÙØ±", url: "#" } };
      }

      // Search filter (Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹)
      function applySearch(list){
        const q = (searchInputEl.value || '').trim().toLowerCase();
        if (!q) return list;
        return list.filter(a => String(a.email || '').toLowerCase().includes(q));
      }

      function addMixedToStock(standardText, quickText) {
        const s = S();

        const stdLines = (standardText || '')
          .replace(/\r/g, '')
          .split('\n')
          .map(l => l.trim())
          .filter(l => l.length >= 5);

        const quickLines = (quickText || '')
          .replace(/\r/g, '')
          .split('\n')
          .map(l => l.trim())
          .filter(l => l.length >= 5);

        let addedCount = 0;
        let duplicateCount = 0;
        let invalidCount = 0;

        function existsEmail(email){
          return s.inventory.some(a => a.email === email);
        }

        for (const line of stdLines) {
          const parsed = parseStandardLine(line);
          if (!parsed.ok) { invalidCount++; continue; }
          const acc = parsed.acc;
          if (existsEmail(acc.email)) { duplicateCount++; continue; }
          s.inventory.push(acc); addedCount++;
        }

        for (const line of quickLines) {
          if (line.includes(';')) { invalidCount++; continue; }
          const parsed = parseQuickLine(line);
          if (!parsed.ok) { invalidCount++; continue; }
          const acc = parsed.acc;
          if (existsEmail(acc.email)) { duplicateCount++; continue; }
          s.inventory.push(acc); addedCount++;
        }

        saveActive();
        updateUI();
        return { addedCount, duplicateCount, invalidCount };
      }

      function addToStock() {
        flash(addBtn);
        const standard = bulkInputEl.value;
        const quick = quickInputEl.value;

        if (!standard.trim() && !quick.trim()) {
          showToast('Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ©!', 'error');
          return;
        }

        const { addedCount, duplicateCount, invalidCount } = addMixedToStock(standard, quick);

        bulkInputEl.value = '';
        quickInputEl.value = '';

        let msg = `(${activeTab === TABS.MAIN ? 'Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ' : 'Gemini'}) ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${addedCount} Ø­Ø³Ø§Ø¨.`;
        if (duplicateCount) msg += ` (Ù…ÙƒØ±Ø±: ${duplicateCount})`;
        if (invalidCount) msg += ` (ØºÙŠØ± ØµØ§Ù„Ø­: ${invalidCount})`;

        showToast(msg, addedCount ? 'success' : 'error');
      }

      function pullAccount() {
        flash(pullBtn);
        const s = S();
        const list = applySearch(s.inventory);

        if (list.length === 0) {
          showToast('Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙØ§Ø±Øº (Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¨Ø­Ø«).', 'error');
          return;
        }

        // Ø¥Ø°Ø§ ÙÙŠ Ø¨Ø­Ø«ØŒ Ù†Ø³Ø­Ø¨ Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø© Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        let idx = 0;
        if ((searchInputEl.value || '').trim()) {
          const firstEmail = list[0].email;
          idx = s.inventory.findIndex(a => a.email === firstEmail);
          if (idx < 0) idx = 0;
        }

        const acc = s.inventory.splice(idx, 1)[0];
        s.currentAccount = acc;
        s.pulledCounter++;

        // Undo info
        setUndo(activeTab, { acc, idx, time: Date.now() });

        saveActive();
        displayResult(acc);
        updateUI();
        showToast('ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
      }

      function clearStorage() {
        flash(clearBtn);
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø®Ø²ÙˆÙ† (${activeTab === TABS.MAIN ? 'Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ' : 'Gemini'}) Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ`)) return;

        const s = S();
        s.inventory = [];
        s.pulledCounter = 0;
        s.currentAccount = null;

        const keys = K();
        localStorage.removeItem(keys.data);
        localStorage.removeItem(keys.pulled);
        localStorage.removeItem(keys.last);
        localStorage.removeItem(keys.undo);

        updateUI();
        showToast('ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'success');
      }

      async function copyField(type) {
        const s = S();
        const acc = s.currentAccount || getLastPulled(activeTab);
        if (!acc) {
          showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ Ù„Ù„Ù†Ø³Ø®.', 'error');
          return;
        }

        let text = '';
        let label = '';
        if (type === 'email') { text = acc.email; label = 'Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„'; }
        else if (type === 'password') { text = acc.password; label = 'Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯'; }
        else { text = acc.recovery; label = 'Ø§Ù„ØªØ­Ù‚Ù‚'; }

        const ok = await copyText(String(text || ''));
        showToast(ok ? `ØªÙ… Ù†Ø³Ø® ${label}` : 'ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® (Ø¬Ø±Ù‘Ø¨ HTTPS Ø£Ùˆ localhost)', ok ? 'copy' : 'error');
      }

      async function copyFullCombo() {
        flash(copyFullBtn);
        const s = S();
        const acc = s.currentAccount || getLastPulled(activeTab);
        if (!acc) {
          showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.', 'error');
          return;
        }

        const textToCopy =
          `Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„: ${acc.email}\n` +
          `Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯: ${acc.password}\n` +
          `Ø§Ù„ØªØ­Ù‚Ù‚: ${acc.recovery}\n` +
          `Ø±Ø§Ø¨Ø· Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${acc.url || "#"}`;

        const ok = await copyText(textToCopy);
        showToast(ok ? 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§Ù…Ù„Ø©' : 'ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® (Ø¬Ø±Ù‘Ø¨ HTTPS Ø£Ùˆ localhost)', ok ? 'success' : 'error');
      }

      async function copyCompact() {
        flash(copyCompactBtn);
        const s = S();
        const acc = s.currentAccount || getLastPulled(activeTab);
        if (!acc) {
          showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨.', 'error');
          return;
        }
        // Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ (Ù…ÙÙŠØ¯ Ù„Ù„Ù‘ØµÙ‚ Ø§Ù„Ø³Ø±ÙŠØ¹)
        const line = `${acc.email};${acc.password};${acc.recovery || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'};${acc.url || '#'}`;
        const ok = await copyText(line);
        showToast(ok ? 'ØªÙ… Ù†Ø³Ø® Ø¢Ø®Ø± Ø­Ø³Ø§Ø¨ (Ø³Ø·Ø± ÙˆØ§Ø­Ø¯)' : 'ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®', ok ? 'copy' : 'error');
      }

      function deleteLastPulled() {
        flash(deleteLastBtn);
        const s = S();
        const acc = s.currentAccount || getLastPulled(activeTab);
        if (!acc) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨.', 'error'); return; }

        s.currentAccount = null;
        clearLastPulled(activeTab);
        saveActive();
        resultAreaEl.classList.add('hidden');
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø©', 'success');
      }

      function restoreLastPulled() {
        flash(restoreBtn);
        const s = S();
        const acc = s.currentAccount || getLastPulled(activeTab);
        if (!acc) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ Ù„Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹.', 'error'); return; }

        // ÙŠØ±Ø¬Ø¹ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        if (!s.inventory.some(a => a.email === acc.email)) {
          s.inventory.unshift(acc);
        }

        if (s.pulledCounter > 0) s.pulledCounter--;
        s.currentAccount = null;
        clearLastPulled(activeTab);

        saveActive();
        updateUI();
        showToast('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', 'success');
      }

      function moveToGemini() {
        flash(moveToGeminiBtn);

        // Ø§Ù„Ù†Ù‚Ù„ Ù…Ø·Ù„ÙˆØ¨ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠ
        if (activeTab !== TABS.MAIN) {
          showToast('Ø²Ø± Ø§Ù„Ù†Ù‚Ù„ ÙŠØ¹Ù…Ù„ Ù…Ù† (Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) Ø¥Ù„Ù‰ (Gemini).', 'error');
          return;
        }

        const sMain = store.main;
        const acc = sMain.currentAccount || getLastPulled(TABS.MAIN);
        if (!acc) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ Ù„Ù„Ù†Ù‚Ù„.', 'error'); return; }

        const sGem = store.gemini;

        // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        if (sGem.inventory.some(a => a.email === acc.email)) {
          showToast('Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù…Ø®Ø²ÙˆÙ† Gemini (ØªÙ… Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±).', 'error');
          return;
        }

        // Ø£Ø¶ÙÙ‡ Ø¥Ù„Ù‰ Gemini (Ø£ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)
        sGem.inventory.unshift(acc);

        // Ø§Ø­ÙØ¸ Gemini
        localStorage.setItem(STORAGE_KEYS.gemini.data, JSON.stringify(sGem.inventory));

        // Ø§Ø­Ø°Ù Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø­ØªÙ‰ ÙŠØµÙŠØ± "Ù†Ù‚Ù„" ÙØ¹Ù„ÙŠ)
        sMain.currentAccount = null;
        clearLastPulled(TABS.MAIN);
        localStorage.setItem(STORAGE_KEYS.main.data, JSON.stringify(sMain.inventory));
        localStorage.setItem(STORAGE_KEYS.main.pulled, String(sMain.pulledCounter));

        updateUI();
        showToast('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¥Ù„Ù‰ Ù…Ø®Ø²ÙˆÙ† Gemini', 'success');
      }

      function undoLastPull() {
        flash(undoPullBtn);
        const undo = getUndo(activeTab);
        if (!undo || !undo.acc) {
          showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ© Ø³Ø­Ø¨ Ù„Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.', 'error');
          return;
        }

        const s = S();
        // Ø±Ø¬Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù…ÙƒØ§Ù†Ù‡ Ø¥Ù† Ø£Ù…ÙƒÙ†ØŒ ÙˆØ¥Ù„Ø§ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        const idx = Number.isFinite(undo.idx) ? Math.max(0, Math.min(undo.idx, s.inventory.length)) : 0;
        if (!s.inventory.some(a => a.email === undo.acc.email)) {
          s.inventory.splice(idx, 0, undo.acc);
        }
        if (s.pulledCounter > 0) s.pulledCounter--;

        // Ø§Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„Ù€ last
        s.currentAccount = null;
        clearLastPulled(activeTab);
        setUndo(activeTab, null);

        saveActive();
        updateUI();
        showToast('ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø³Ø­Ø¨', 'success');
      }

      async function importTxtFile(file) {
        if (!file) return;
        flash(importBtn);

        if (!file.name.toLowerCase().endsWith('.txt')) {
          showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù TXT ÙÙ‚Ø·', 'error');
          return;
        }

        try {
          const content = await file.text();
          const { addedCount, duplicateCount, invalidCount } = addMixedToStock(content, '');

          let msg = `ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: +${addedCount}`;
          if (duplicateCount) msg += ` (Ù…ÙƒØ±Ø±: ${duplicateCount})`;
          if (invalidCount) msg += ` (ØºÙŠØ± ØµØ§Ù„Ø­: ${invalidCount})`;

          showToast(msg, addedCount ? 'success' : 'error');
        } catch (e) {
          showToast('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error');
        }
      }

      function exportStockToTxt() {
        flash(exportBtn);
        const s = S();

        const list = applySearch(s.inventory);
        if (!list.length) {
          showToast('Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙØ§Ø±Øº (Ø£Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¨Ø­Ø«).', 'error');
          return;
        }

        const content = list
          .map(acc => `${acc.email};${acc.password};${acc.recovery};${acc.url}`)
          .join('\n');

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `${activeTab === TABS.MAIN ? 'inventory' : 'gemini'}_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);
        showToast(`ØªÙ… ØªØµØ¯ÙŠØ± ${list.length} Ø­Ø³Ø§Ø¨`, 'success');
      }

      function updateSmartSummary(){
        const s = S();
        const list = applySearch(s.inventory);
        const last = s.currentAccount || getLastPulled(activeTab);

        // ØªÙ‚Ø¯ÙŠØ± Ø³Ø±ÙŠØ¹ "Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" (Ø¨Ø³ Ù„Ù„Ø¹Ø±Ø¶)
        function strength(p){
          if(!p) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
          let score = 0;
          if(p.length >= 10) score++;
          if(/[A-Z]/.test(p)) score++;
          if(/[0-9]/.test(p)) score++;
          if(/[^A-Za-z0-9]/.test(p)) score++;
          if(score <= 1) return 'Ø¶Ø¹ÙŠÙ';
          if(score === 2) return 'Ù…ØªÙˆØ³Ø·';
          return 'Ù‚ÙˆÙŠ';
        }

        const tabName = activeTab === TABS.MAIN ? 'Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ' : 'Gemini';
        const now = new Date().toLocaleDateString('ar-IQ');

        smartSummary.textContent =
          `Ø§Ù„ØªØ¨ÙˆÙŠØ¨: ${tabName} â€” Ø§Ù„ØªØ§Ø±ÙŠØ®: ${now} â€” Ø§Ù„Ù…ØªØ§Ø­ (Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø«): ${list.length} â€” `
          + `Ø§Ù„Ù…Ø³Ø­ÙˆØ¨: ${s.pulledCounter} â€” `
          + (last ? `Ø¢Ø®Ø± Ø­Ø³Ø§Ø¨: ${last.email} (Ù‚ÙˆØ© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯: ${strength(last.password)})` : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø­ÙˆØ¨ Ø­Ø§Ù„ÙŠØ§Ù‹');
      }

      function toggleSmartPanel(){
        flash(smartStatsBtn);
        smartPanel.classList.toggle('hidden');
        updateSmartSummary();
      }

      function setActiveTab(tab){
        activeTab = tab;

        // UI
        tabMain.classList.toggle('tab-active', tab === TABS.MAIN);
        tabGemini.classList.toggle('tab-active', tab === TABS.GEMINI);

        titleNameEl.textContent = tab === TABS.MAIN ? 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø°ÙƒÙŠ' : 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø°ÙƒÙŠ â€” Gemini';

        // Ø²Ø± Ø§Ù„Ù†Ù‚Ù„ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        moveToGeminiBtn.style.display = (tab === TABS.MAIN) ? '' : 'none';

        // load & show
        loadActive();

        const s = S();
        const last = getLastPulled(activeTab);
        if (last) s.currentAccount = last;

        updateUI();
        showToast(`ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰: ${tab === TABS.MAIN ? 'Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ' : 'Gemini'}`, 'info');
      }

      // Events
      toggleBtn.addEventListener('click', () => { flash(toggleBtn); inputSectionEl.classList.toggle('hidden'); });
      clearBtn.addEventListener('click', clearStorage);
      addBtn.addEventListener('click', addToStock);
      pullBtn.addEventListener('click', pullAccount);
      copyFullBtn.addEventListener('click', copyFullCombo);

      restoreBtn.addEventListener('click', restoreLastPulled);
      deleteLastBtn.addEventListener('click', deleteLastPulled);
      moveToGeminiBtn.addEventListener('click', moveToGemini);

      importBtn.addEventListener('click', () => { flash(importBtn); importFile.click(); });
      importFile.addEventListener('change', async () => {
        const file = importFile.files && importFile.files[0] ? importFile.files[0] : null;
        await importTxtFile(file);
        importFile.value = '';
      });

      exportBtn.addEventListener('click', exportStockToTxt);

      document.querySelectorAll('[data-copy]').forEach(card => {
        card.addEventListener('click', () => { flash(card); copyField(card.getAttribute('data-copy')); });
      });

      // Tabs
      tabMain.addEventListener('click', () => setActiveTab(TABS.MAIN));
      tabGemini.addEventListener('click', () => setActiveTab(TABS.GEMINI));

      // Smart tools
      smartStatsBtn.addEventListener('click', toggleSmartPanel);
      clearSearchBtn.addEventListener('click', () => { flash(clearSearchBtn); searchInputEl.value=''; updateUI(); });
      copyCompactBtn.addEventListener('click', copyCompact);
      undoPullBtn.addEventListener('click', undoLastPull);

      searchInputEl.addEventListener('input', () => updateUI());

      // Initial load: Ø­Ù…Ù‘Ù„ Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ù…Ø±Ø© Ø­ØªÙ‰ Ø²Ø± Ø§Ù„Ù†Ù‚Ù„ ÙŠØ´ØªØºÙ„ ÙÙˆØ±Ø§Ù‹
      function loadBothOnce(){
        // MAIN
        activeTab = TABS.MAIN;
        loadActive();
        let last = getLastPulled(TABS.MAIN);
        if (last) store.main.currentAccount = last;

        // GEMINI
        activeTab = TABS.GEMINI;
        loadActive();
        last = getLastPulled(TABS.GEMINI);
        if (last) store.gemini.currentAccount = last;

        // Ø±Ø¬Ù‘Ø¹ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        activeTab = TABS.MAIN;
      }

      window.addEventListener('load', () => {
        loadBothOnce();
        setActiveTab(TABS.MAIN);
      });

      /* =========================
         Snow (Ø®ÙÙŠÙ ÙˆØ´ÙØ§Ù ÙˆØ³Ø±ÙŠØ¹)
         ========================= */
      const canvas = document.getElementById('snowCanvas');
      const ctx = canvas.getContext('2d', { alpha: true });
      let W = 0, H = 0;

      function resize(){
        W = canvas.width = window.innerWidth;
        H = canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize, { passive:true });
      resize();

      // Ø¹Ø¯Ø¯ Ù‚Ù„ÙŠÙ„ Ø­ØªÙ‰ ÙŠØ¨Ù‚Ù‰ Ø³Ù„Ø³
      const flakes = Array.from({ length: 55 }, () => ({
        x: Math.random()*W,
        y: Math.random()*H,
        r: 0.6 + Math.random()*1.6,
        v: 0.25 + Math.random()*0.9,
        drift: (Math.random()*0.6) - 0.3,
        a: 0.12 + Math.random()*0.20
      }));

      function snowTick(){
        ctx.clearRect(0,0,W,H);
        for(const f of flakes){
          f.y += f.v;
          f.x += f.drift;

          if (f.y > H + 5) { f.y = -5; f.x = Math.random()*W; }
          if (f.x > W + 5) f.x = -5;
          if (f.x < -5) f.x = W + 5;

          ctx.beginPath();
          ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
          ctx.closePath();
          // Ù„ÙˆÙ† Ø£Ø¨ÙŠØ¶ Ø´ÙØ§Ù
          ctx.fillStyle = `rgba(255,255,255,${f.a})`;
          ctx.fill();
        }
        requestAnimationFrame(snowTick);
      }
      snowTick();

    })();
  </script>
</body>
</html>
